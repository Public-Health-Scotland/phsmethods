---
title: "Using percent vectors"
output: rmarkdown::html_vignette
author: Nick Christofides
vignette: >
  %\VignetteIndexEntry{Using percent vectors}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Let's start by loading the phsmethods package

```{r setup}
library(phsmethods)
```

### Motivation

Working with percentages in R can be frustrating to say the least. A typical workflow with generating percentages might look like this:

-   Generate proportions
-   Scale up proportions to percentages (multiplying by 100)
-   Round percentages
-   Convert percentages to characters
-   Append a percentage symbol
-   Use proportions for math operations and rounding
-   Use formatted percentage strings for outputs

With `<percent>` vectors, this workflow is reduced to:

-   Generate proportions
-   Convert to percentages

This is clearly much simpler and allows for cleaner and more reproducible code.

### Creating percentages

The primary function for converting to percentages is `as_percent()`. This converts a `<numeric>` vector to a `<percent>` vector, handling the formatting and rounding when needed, i.e printing or converting to a character vector.

```{r}
(p <- as_percent(0.055))
```

Internally the numeric vector is left as-is which can be confirmed by examining the vector via `unclass(x)`.

```{r}
unclass(p)
```

The only time percentage formatting actually happens is when the `<percent>` vector is printed or converted to a character vector (via `as.character` or `format`).

```{r}
print(p)
as.character(p)
format(p)
```

### Rounding

Percentages are rounded using a round-halves-up approach. The rationale for straying away from R's round-to-even is that readers generally expect percentages to be rounded this way in formatted outputs such as papers, reports, etc. We are less concerned with statistical bias and more concerned with formatting.

There are two main ways to control how percent vectors are rounded:

### Rounding via `as_percent` + `digits`

`as_percent` does two things:

1 - It creates a `<percent>` vector \
2 - It sets the ".digits" attribute which controls how the percent vector is printed downstream.

```{r}
p2 <- as_percent(p, digits = 0)

# Prints and formats to 0 decimal places
print(p2)
as.character(p2)

# Underlying data has not been rounded!
unclass(p2)
```

### Rounding via `round()`

This method will 'physically' round the numbers

```{r}
p3 <- round(p, digits = 0)

p3

# Underlying data has been rounded
unclass(p3)
```

In practice this means that rounding with `as_percent` is more flexible as it reduces downstream errors that can accumulate from premature rounding.

### Math with percent vectors

A strong feature of `<percent>` vectors is the ability to use them in mathematical contexts without extra unnecessary work.

```{r}
# Helper to create literal percentages
percent <- function(x){
  as_percent(x / 100)
}
```

Addition, subtraction, multiplication and division

```{r}
percent(50) + percent(25) # = 50% + 25% = 75%
percent(50) - percent(25) # = 50% - 25% = 25%
percent(50) * percent(25) # = 50% * (1/4) = 12.5%
percent(50) / percent(25) # = 50% / (1/4) = 200%
```

More rounding functions

```{r}
percentages <- percent(seq(-0.1, 0.1, by = 0.05))
floor(percentages)
ceiling(percentages)
trunc(percentages)
round(percentages)
round(percentages, 1)
round(percentages, 2)
```

Statistical summaries

```{r}
percentages <- percent(seq(0, 100, by = 10))

range(percentages)
mean(percentages)
median(percentages)
sum(percentages)
cumsum(percentages)
```

### percent vectors and tidyverse

percent vectors also print nicely in tibbles

```{r}
library(dplyr)
species <- starwars |> 
  count(species, sort = TRUE) |> 
  mutate(perc = as_percent(n / sum(n)))
species |> 
  slice_head(n = 5)
```

percent vector columns can be handled in the same way as any other vector, e.g. via `mutate()`

```{r}
species |> 
  mutate(rounded_perc = round(perc))
```

### percent vectors and `ggplot2`

```{r, fig.width = 7, fig.height = 6}
library(ggplot2)
starwars |> 
    ggplot(aes(species)) + 
    geom_bar(aes(fill = eye_color), position = "fill") + 
    coord_flip() +
    scale_y_continuous(name = "Percentage", labels = as_percent) +
    theme_minimal()
```

With the new release of ggplot2 4.0.0, there is potential for embedding `<percent>` vectors more formally and programmatically into `ggplot2`. This is currently being worked on.
